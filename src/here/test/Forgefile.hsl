# Here Unittest

include ~/toolsets/gcc/gcc-app.hsl

var sources type list;
var includes type list;
var libraries type list;
var ldflags type list;
var cflags type list;

project here-test : toolset "gcc-c-app" : $sources, $includes, $cflags,
                                          $libraries, $ldflags, "here_unittest" ;


here-test.prologue() {
    $sources.ls(".*\.c");
    $ldflags = hefesto.sys.get_option("ldflags");
    #$ldflags.add_item("../here.o");
    #$ldflags.add_item("../here_ctx.o");
    #$ldflags.add_item("../here_mem.o");
    #$ldflags.add_item("../here_mmachine.o");
    $ldflags.add_item("../libhere.a");
    $includes = hefesto.sys.get_option("includes");
    $includes = hefesto.sys.get_option("libraries");
    $includes = hefesto.sys.get_option("cflags");
}

function run_unittests() : result type int {
    var retval type int;
    if (hefesto.sys.os_name() != "windows") {
        $retval = hefesto.sys.run("./here_unittest");
    } else {
        $retval = hefesto.sys.run("here_unittest.exe");
    }
    result $retval;
}

here-test.epilogue() {
    if (hefesto.sys.last_forge_result() == 0) {
        if (run_unittests() != 0) hefesto.sys.exit(1);
    }
}
